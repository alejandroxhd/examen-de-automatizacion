image: maven:3.9.6-eclipse-temurin-17

stages:
  - build
  - unit_tests
  - integration_tests
  - acceptance_tests
  - deploy_test
  - rollback

variables:
  MAVEN_OPTS: "-Dmaven.test.skip=false"

build:
  stage: build
  script:
    - mvn -B -DskipTests clean package
  artifacts:
    paths:
      - target/*.jar
    expire_in: 1 week

unit_tests:
  stage: unit_tests
  needs: ["build"]
  script:
    - mvn -B -Dtest='*Test' -DfailIfNoTests=false test
  artifacts:
    when: always
    paths:
      - target/surefire-reports

integration_tests:
  stage: integration_tests
  needs: ["build"]
  script:
    - mvn -B failsafe:integration-test failsafe:verify
  artifacts:
    when: always
    paths:
      - target/failsafe-reports

acceptance_tests:
  stage: acceptance_tests
  needs: ["build"]
  script:
    - mvn -B -Dtest='*AcceptanceTest' -DfailIfNoTests=false test
  artifacts:
    when: always
    paths:
      - target/surefire-reports

deploy_test:
  stage: deploy_test
  needs: ["build", "acceptance_tests"]
  script:
    - mkdir -p deploy/test/releases
    - cp target/*.jar "deploy/test/releases/app-$CI_COMMIT_SHORT_SHA.jar"
    - ln -sfn "app-$CI_COMMIT_SHORT_SHA.jar" deploy/test/current.jar || echo "En Windows o ciertos runners, ln -sfn puede no funcionar"
    - echo "Aplicación desplegada en ambiente de prueba usando current.jar -> app-$CI_COMMIT_SHORT_SHA.jar"
  environment:
    name: testing
    url: http://testing.example.local
  artifacts:
    paths:
      - deploy/test/
    expire_in: 1 week

rollback_test:
  stage: rollback
  needs: ["deploy_test"]
  when: manual
  script: "echo 'Rollback en ambiente de prueba simulado: se marca esta versión como revertida.'"
  environment:
    name: testing
    action: stop
